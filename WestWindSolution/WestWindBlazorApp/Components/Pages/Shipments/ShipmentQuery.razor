@page "/shipments/query"
<!--

Additional package setup

you will need to add the NuGet package Blazor.BootStrap (do first)
you will need to add a using statement
-->
@using BlazorBootstrap;

@using WestWindSystem.BLL;
@using WestWindSystem.Entities;

<h3>Shipment Query</h3>

@if (!string.IsNullOrWhiteSpace(_infoMessage))
{
    <div class="alert alert-info">@_infoMessage</div>
}

@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

<div class="row mb-3">
    <div class="col-md-3">
        <label for="month" class="form-label">Month</label>
        <select id="month" class="form-select" @bind="_monthArg">
            @foreach (var m in Enumerable.Range(1, 12))
            {
                <option value="@m">@(new DateTime(2025, m, 1).ToString("MMMM"))</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label for="year" class="form-label">Year</label>
        <input id="year"
               type="number"
               class="form-control"
               @bind="_yearArg" />
    </div>

    <div class="col-md-3 align-self-end">
        <button class="btn btn-primary" @onclick="SearchAsync">
            Search
        </button>
    </div>
</div>

@if (_shipments != null && _shipments.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>OrderID</th>
                <th>Date</th>
                <th>Shipper</th>
                <th>Freight($)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var currentShipment in _shipments)
            {
                <tr>
                    <td>@currentShipment.ShipmentID</td>
                    <td>@currentShipment.OrderID</td>
                    <td>@currentShipment.ShippedDate.ToString("MMM dd, yyyy")</td>
                    <td>@currentShipment.ShipViaNavigation.CompanyName</td>
                    <td align="right">
                        @(string.Format("{0:#,##0.00}", currentShipment.FreightCharge))
                    </td>
                    <td>
                        <a class="btn btn-sm btn-outline-secondary"
                           href="/shipments/crud/@currentShipment.ShipmentID">Edit</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <Pagination ActivePageNumber="_currentPageNumber"
                TotalPages="GetTotalPages()"
                PageChanged="OnPageChanged">
    </Pagination>
}

@code {
    // query args
    private int _yearArg = 2017;
    private int _monthArg = 11;

    // data
    private List<Shipment>? _shipments;

    // injected service (property, no underscore)
    [Inject]
    public ShipmentServices ShipmentServices { get; set; } = default!;

    // pagination variables
    private int _currentPageNumber = 1;  // the current page to display
    private int _itemsPerPage = 5;
    private int _totalItems = 0; // total number of rows for the query

    // feedback messages
    private string? _infoMessage;
    private string? _errorMessage;

    private async Task SearchAsync()
    {
        // when user clicks Search, start at page 1 and recalc total count
        await LoadShipmentsAsync(resetPageNumber: true, recalcTotal: true);
    }

    private async Task LoadShipmentsAsync(bool resetPageNumber, bool recalcTotal)
    {
        // clear previous messages for each load
        _infoMessage = string.Empty;
        _errorMessage = string.Empty;

        if (resetPageNumber)
        {
            _currentPageNumber = 1;
        }

        try
        {
            if (recalcTotal)
            {
                _totalItems = await ShipmentServices
                    .CountShipmentsByYearAndMonth(_yearArg, _monthArg);
            }

            _shipments = await ShipmentServices.FindShipmentsByYearAndMonthPaging(
                _yearArg,
                _monthArg,
                _currentPageNumber,
                _itemsPerPage);

            if (_totalItems == 0)
            {
                _infoMessage = "No shipments found for the selected month and year.";
            }
        }
        catch (ArgumentOutOfRangeException ex)
        {
            _errorMessage = $"Data Value Error: {ex.Message}";
            _shipments = new List<Shipment>();
        }
        catch (Exception ex)
        {
            _errorMessage = $"System Error: {ex.Message}";
            _shipments = new List<Shipment>();
        }

        StateHasChanged();
    }

    private int GetTotalPages()
    {
        return (_totalItems + _itemsPerPage - 1) / _itemsPerPage;
    }

    private async Task OnPageChanged(int newPageNumber)
    {
        _currentPageNumber = newPageNumber;

        _shipments = await ShipmentServices.FindShipmentsByYearAndMonthPaging(
            _yearArg,
            _monthArg,
            _currentPageNumber,
            _itemsPerPage);
    }
}
