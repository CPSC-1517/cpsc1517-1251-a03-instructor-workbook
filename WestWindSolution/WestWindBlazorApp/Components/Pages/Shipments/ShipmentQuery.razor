@page "/shipments/query"
<!--

Additional package setup

you will need to add the NuGet package Blazor.BootStrap (do first)
you will need to add a using statement-->
@using BlazorBootstrap;

@using WestWindSystem.BLL;
@using WestWindSystem.Entities;

<h3>ShipmentQuery</h3>

@if (shipments != null && shipments.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>OrderID</th>
                <th>Date</th>
                <th>Shipper</th>
                <th>Freight($)</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var currentShipment in shipments)
            {
                <tr>
                   <td>@currentShipment.ShipmentID</td>
                   <td>@currentShipment.OrderID</td>
                   <td>@currentShipment.ShippedDate.ToString("MMM dd, yyyy")</td>
                   <td>@currentShipment.ShipViaNavigation.CompanyName</td>
                    <td align="right">@(string.Format("{0:#,##0.00}", currentShipment.FreightCharge))</td>
                </tr>
            }
        </tbody>
    </table>

    <Pagination ActivePageNumber="currentPageNumber"
            TotalPages="GetTotalPages()"
            PageChanged="OnPageChanged">
   </Pagination>
}


@code {
    private int yeararg = 2017;
    private int montharg = 11;
    private List<Shipment>? shipments = null;

    [Inject]
    public ShipmentServices _shipmentServices { get; set; }

    // pagination variables
    private int currentPageNumber = 1;  // the current page to display
    private int itemsPerPage = 5;
    private int totalItems = 0; // total number of rows for the query

    protected override async Task OnInitializedAsync()
    {
        try
        {
            totalItems = await _shipmentServices.CountShipmentsByYearAndMonth(yeararg, montharg);
            shipments = await _shipmentServices.FindShipmentsByYearAndMonthPaging(
                yeararg, montharg, currentPageNumber, itemsPerPage);
        }
        catch(ArgumentOutOfRangeException ex)
        {
            Console.WriteLine($"Dtga value error: {ex.Message}");
        }
        catch(Exception ex)
        {
            Console.WriteLine($"System error: {ex.Message}");
        }
    }

    private int GetTotalPages()
    {
        return (totalItems + itemsPerPage - 1) / itemsPerPage;
    }

    private async Task OnPageChanged(int newPageNumber)
    {
        currentPageNumber = newPageNumber;
        shipments = await _shipmentServices.FindShipmentsByYearAndMonthPaging(
            yeararg,
            montharg,
            currentPageNumber,
            itemsPerPage
        );
    }
}
