@page "/shipments/query"
<!--

Additional package setup

you will need to add the NuGet package Blazor.BootStrap (do first)
you will need to add a using statement-->
@using BlazorBootstrap;

@using WestWindSystem.BLL;
@using WestWindSystem.Entities;

<h3>Shipment Query</h3>

@if (!string.IsNullOrWhiteSpace(infoMessage))
{
    <div class="alert alert-info">@infoMessage</div>
}

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="row mb-3">
    <div class="col-md-3">
        <label for="month" class="form-label">Month</label>
        <select id="month" class="form-select" @bind="montharg">
            @foreach (var m in Enumerable.Range(1, 12))
            {
                <option value="@m">@(new DateTime(2025, m, 1).ToString("MMMM"))</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label for="year" class="form-label">Year</label>
        <input id="year"
               type="number"
               class="form-control"
               @bind="yeararg" />
    </div>

    <div class="col-md-3 align-self-end">
        <button class="btn btn-primary" @onclick="SearchAsync">
            Search
        </button>
    </div>
</div>

@if (shipments != null && shipments.Count > 0)
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>OrderID</th>
                <th>Date</th>
                <th>Shipper</th>
                <th>Freight($)</th>
            </tr>
        </thead>
        <tbody>
            @foreach(var currentShipment in shipments)
            {
                <tr>
                   <td>@currentShipment.ShipmentID</td>
                   <td>@currentShipment.OrderID</td>
                   <td>@currentShipment.ShippedDate.ToString("MMM dd, yyyy")</td>
                   <td>@currentShipment.ShipViaNavigation.CompanyName</td>
                    <td align="right">@(string.Format("{0:#,##0.00}", currentShipment.FreightCharge))</td>
                </tr>
            }
        </tbody>
    </table>

    <Pagination ActivePageNumber="currentPageNumber"
            TotalPages="GetTotalPages()"
            PageChanged="OnPageChanged">
   </Pagination>
}


@code {
    private int yeararg = 2017;
    private int montharg = 11;
    private List<Shipment>? shipments = null;

    [Inject]
    public ShipmentServices _shipmentServices { get; set; }

    // pagination variables
    private int currentPageNumber = 1;  // the current page to display
    private int itemsPerPage = 5;
    private int totalItems = 0; // total number of rows for the query

    // feedback messages
    private string? infoMessage;
    private string? errorMessage;

    private async Task SearchAsync()
    {
        // when user clicks Search, start at page 1 and recalc total count
        await LoadShipmentsAsync(true,true);
    }


    private async Task LoadShipmentsAsync(bool resetPageNumber, bool recalcTotal)
    {
        // clear previous messages for each load
        infoMessage = string.Empty;
        errorMessage = string.Empty;

        if (resetPageNumber)
        {
            currentPageNumber = 1;
        }

        try
        {
            if (recalcTotal)
            {
                totalItems = await _shipmentServices
                    .CountShipmentsByYearAndMonth(yeararg, montharg);
            }

            shipments = await _shipmentServices.FindShipmentsByYearAndMonthPaging(
                yeararg,
                montharg,
                currentPageNumber,
                itemsPerPage);

            if (totalItems == 0)
            {
                infoMessage = "No shipments found for the selected month and year.";
            }
        }
        catch (ArgumentOutOfRangeException ex)
        {
            errorMessage = $"Data Value Error: {ex.Message}";
            shipments = new List<Shipment>();
        }
        catch (Exception ex)
        {
            errorMessage = $"System Error: {ex.Message}";
            shipments = new List<Shipment>();
        }

        StateHasChanged();
    }

    private int GetTotalPages()
    {
        return (totalItems + itemsPerPage - 1) / itemsPerPage;
    }

    private async Task OnPageChanged(int newPageNumber)
    {
        currentPageNumber = newPageNumber;
        shipments = await _shipmentServices.FindShipmentsByYearAndMonthPaging(
            yeararg,
            montharg,
            currentPageNumber,
            itemsPerPage
        );
    }
}
