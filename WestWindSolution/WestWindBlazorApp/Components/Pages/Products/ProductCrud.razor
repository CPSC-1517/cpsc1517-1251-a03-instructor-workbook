@page "/products/crud/{ProductID:int?}"
@using WestWindSystem.BLL
@using WestWindSystem.Entities
@inject ProductServices _currentProductService
@inject CategoryServices CurrentCategoryService
@inject SupplierServices CurrentSupplierService
@inject IJSRuntime CurrentJSRuntime
@inject NavigationManager CurrentNavigationManager

<h3>Manage Products</h3>

@if (!string.IsNullOrEmpty(_feedback))
{
    <div class="alert alert-info mt-3">
        @_feedback
    </div>
}

<EditForm EditContext="_editContext" OnValidSubmit="SaveAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label" for="ProductName">Product Name</label>
        <InputText  id="ProductName" 
                    class="form-control"
                    @bind-Value="_currentProduct.ProductName" />
        <ValidationMessage For="@(() => _currentProduct.ProductName)" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="CategoryID">Category</label>
        <InputSelect id="CategoryID" 
                     class="form-select" 
                     @bind-Value="_currentProduct.CategoryID">
            <option value="0">-- select a category --</option>
            @foreach (var currentCategory in _categories)
            {
                <option value="@currentCategory.CategoryID">@currentCategory.CategoryName</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => _currentProduct.CategoryID)" />
    </div>

    <div class="mb-3">
        <label class="form-label" for="SupplierID">Supplier</label>
        <InputSelect id="SupplierID"
                     class="form-select" 
                     @bind-Value="_currentProduct.SupplierID">
            <option value="0">-- select a supplier --</option>
            @foreach (var currentSupplier in _suppliers)
            {
                <option value="@currentSupplier.SupplierID">@currentSupplier.CompanyName</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => _currentProduct.SupplierID)" />
    </div>

    <div class="row">
        <div class="col-md-3 mb-3">
            <label class="form-label" for="QuantityPerUnit">Quantity / Unit</label>
            <InputText class="form-control"
                       id="QuantityPerUnit"
                       @bind-Value="_currentProduct.QuantityPerUnit" />
            <ValidationMessage For="@(() => _currentProduct.QuantityPerUnit)" />
        </div>

        <div class="col-md-3 mb-3">
            <label class="form-label" for="MinimumOrderQuantity">Minimum Order Quantity</label>
            <InputNumber class="form-control"
                         id="MinimumOrderQuantity"
                         @bind-Value="_currentProduct.MinimumOrderQuantity" />
            <ValidationMessage For="@(() => _currentProduct.MinimumOrderQuantity)" />
        </div>

        <div class="col-md-3 mb-3">
            <label class="form-label" for="UnitPrice">Unit Price</label>
            <InputNumber class="form-control"
                         id="UnitPrice"
                         @bind-Value="_currentProduct.UnitPrice" />
            <ValidationMessage For="@(() => _currentProduct.UnitPrice)" />
        </div>

        <div class="col-md-3 mb-3">
            <label class="form-label" for="UnitsOnOrder">Units On Order</label>
            <InputNumber class="form-control"
                         id="UnitsOnOrder"
                         @bind-Value="_currentProduct.UnitsOnOrder" />
            <ValidationMessage For="@(() => _currentProduct.UnitsOnOrder)" />
        </div>
    </div>


    <button type="submit" class="btn btn-primary me-2">
        @(EditMode ? "Save Changes" : "Create")
    </button>

    @if (EditMode)
    {
        <button type="button"
                class="btn btn-danger me-2"
                @onclick="DeleteProductAsync">
            Discontinued
        </button>
        <button type="button"
                class="btn btn-secondary me-2"
                @onclick="CancelEdit">
            Cancel
        </button>
    }

</EditForm>

@code {
    [Parameter]
    public int? ProductID { get; set; }

    private EditContext _editContext;
    private ValidationMessageStore _messageStore;

    private Product _currentProduct = new();
    private bool EditMode => ProductID.HasValue && ProductID.Value > 0;

    private string _feedback = "";

    private List<Category> _categories = new();
    private List<Supplier> _suppliers = new();

    private void ConfigureEditContext()
    {
        _editContext = new EditContext(_currentProduct);
        _messageStore = new ValidationMessageStore(_editContext);

        _editContext.OnValidationRequested += (sender, eventArgs) =>
        {
            _messageStore.Clear();

            // Sample validation demo
            // Product Name cannot contains the text XXX
            if (!string.IsNullOrWhiteSpace(_currentProduct.ProductName)
                && _currentProduct.ProductName.ToLower().Contains("xxx"))
            {
                _messageStore.Add(
                    _editContext.Field(nameof(_currentProduct.ProductName)),
                    "Product Name is not allowed to contain XXX");
            }
            // Unit Price must be $2.00 or more
            if (_currentProduct.UnitPrice < 2)
            {
                _messageStore.Add(
                    _editContext.Field(nameof(_currentProduct.UnitPrice)),
                    "Unit Price must be >= $2.00");
            }

            // any additional validation...
        };
    }


    protected override async Task OnInitializedAsync()
    {
        _editContext = new EditContext(_currentProduct);
        _messageStore = new ValidationMessageStore(_editContext);

        _editContext.OnValidationRequested += (sender, eventArgs) =>
        {
            // Sample validation demo
            // Product Name cannot contains the text XXX
            if (!string.IsNullOrWhiteSpace(_currentProduct.ProductName) && _currentProduct.ProductName.ToLower().Contains("xxx"))
            {
                _messageStore.Add(_editContext.Field(nameof(_currentProduct.ProductName)), "Product Name are not allowed to contains XXX");
            }
            // Unit Price must be $2.00 or more
            if (_currentProduct.UnitPrice < 2)
            {
                _messageStore.Add(_editContext.Field(nameof(_currentProduct.UnitPrice)), "Unit Price must be >= $2.00");

            }
            // Add any additional validation requirements
        };

        try
        {
            // Fetch list of Categories and Suppliers
            _categories = await CurrentCategoryService.Category_GetAllAsync();
            _suppliers = await CurrentSupplierService.GetAllSuppliersAsync();
            // Check if we need to fetch Product to edit
            if (EditMode)
            {
                var existingProduct = await _currentProductService.GetProductByProductIdAsync(ProductID!.Value);
                if (existingProduct is null)
                {
                    ConfigureEditContext();
                    _messageStore.Add(_editContext.Field(nameof(ProductID)),$"ProductID {ProductID.Value} not found.");
                    _editContext.NotifyValidationStateChanged();
                }
                else
                {
                    _currentProduct = existingProduct;
                }
            }

            ConfigureEditContext();
        }
        catch(Exception ex)
        {
            ConfigureEditContext();
            var modelError = new FieldIdentifier(_editContext.Model, "");
            _messageStore.Add(modelError, $"An unexpected error occurred during initialization: {GetInnerException(ex).Message}");
            _editContext.NotifyValidationStateChanged();
        }
    }

    private async Task SaveAsync()
    {
        try
        {
            if (EditMode)
            {
                await _currentProductService.UpdateProductAsync(_currentProduct);
                _feedback = "Product updated successfully.";
            }
            else
            {
                await _currentProductService.AddProductAsync(_currentProduct);
                _feedback = $"Product created successfully with ID {_currentProduct.ProductID}";

                // reset to a fresh product for the next create
                _currentProduct = new Product();
                ConfigureEditContext(); // recreates EditContext + ValidationMessageStore + OnValidationRequested
            }
        }
        catch (Exception ex)
        {
            // model-level error from BLL / unexpected exceptions
            var modelError = new FieldIdentifier(_editContext.Model, "");
            _messageStore.Add(modelError,
                $"An unexpected error occurred while saving: {GetInnerException(ex).Message}");
            _editContext.NotifyValidationStateChanged();
        }
    }


    private async Task DeleteProductAsync()
    {
        bool confirmed = await CurrentJSRuntime.InvokeAsync<bool>(
                   "confirm", "Are you sure you want to delete this item?");
        if (confirmed)
        {
            try
            {
                if (EditMode)
                {
                    await _currentProductService.DeleteProductAsync(ProductID!.Value);
                }
                CurrentNavigationManager.NavigateTo("/products");
            }
            catch (Exception ex)
            {
                var modelError = new FieldIdentifier(_editContext.Model, "");
                _messageStore.Add(modelError, $"An unexpected error occurred while deleting: {GetInnerException(ex).Message}");
                _editContext.NotifyValidationStateChanged();
            }

        }
    }
    private async Task CancelEdit()
    {
        bool confirmed = await CurrentJSRuntime.InvokeAsync<bool>(
            "confirm", "Are you sure you want to cancel editing this item and navigate back to query page?");
        if (confirmed)
        {
            CurrentNavigationManager.NavigateTo("/products");
        }
    }

    private Exception GetInnerException(Exception ex)
    {
        while (ex.InnerException != null)
        {
            ex = ex.InnerException;
        }
        return ex;
    }
}
